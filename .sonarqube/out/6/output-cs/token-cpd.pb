ÔC
eC:\Users\Alan_Orozco\source\repos\NETMentoringProgram\APIGateway\Aggregators\ItemDetailsAggregator.cs
	namespace 	

APIGateway
 
. 
Aggregators  
{		 
public

 

class

 !
ItemDetailsAggregator

 &
:

' (
IDefinedAggregator

) ;
{ 
public 
async 
Task 
< 
DownstreamResponse ,
>, -
	Aggregate. 7
(7 8
List8 <
<< =
HttpContext= H
>H I 
responseHttpContextsJ ^
)^ _
{ 	
if 
(  
responseHttpContexts $
.$ %
Count% *
!=+ -
$num. /
)/ 0
throw 
new 
ArgumentException +
(+ ,
nameof, 2
(2 3!
ItemDetailsAggregator3 H
)H I
+J K
$str J
,J K
nameofL R
(R S 
responseHttpContextsS g
)g h
)h i
;i j
var 
contentDict 
= 
new !

Dictionary" ,
<, -
string- 3
,3 4
object5 ;
>; <
(< =
)= >
;> ?
var 
headers 
= 
new 
List "
<" #
Header# )
>) *
(* +
)+ ,
;, -
foreach 
( 
var 
response !
in" $ 
responseHttpContexts% 9
)9 :
{ 
var 
content 
= 
await #
GetResponseContent$ 6
(6 7
response7 ?
)? @
;@ A
var 
	baseRoute 
= 
response  (
.( )
Items) .
.. /
DownstreamRoute/ >
(> ?
)? @
;@ A
object 
baseObj 
; 
if 
( 
	baseRoute 
. 
Key !
.! "
Contains" *
(* +
$str+ 4
)4 5
)5 6
baseObj 
= 
JsonSerializer ,
., -
Deserialize- 8
<8 9
ItemDetails9 D
>D E
(E F
contentF M
,M N
new !
JsonSerializerOptions 1
(1 2
)2 3
{4 5'
PropertyNameCaseInsensitive6 Q
=R S
trueT X
}Y Z
)Z [
;[ \
else 
baseObj 
= 
JsonSerializer ,
., -
Deserialize- 8
<8 9
Item9 =
>= >
(> ?
content? F
,F G
new !
JsonSerializerOptions 1
(1 2
)2 3
{4 5'
PropertyNameCaseInsensitive6 Q
=R S
trueT X
}Y Z
)Z [
;[ \
contentDict 
[ 
	baseRoute %
.% &
Key& )
]) *
=+ ,
baseObj- 4
;4 5
MergeHeaders   
(   
response   %
,  % &
headers  ' .
)  . /
;  / 0
}"" 
headers## 
.## 
Add## 
(## 
new## 
Header## "
(##" #
$str### 1
,##1 2
new##3 6
List##7 ;
<##; <
string##< B
>##B C
(##C D
)##D E
{##F G
$str##H Z
}##[ \
)##\ ]
)##] ^
;##^ _
return$$ 
new$$ 
DownstreamResponse$$ )
($$) *
new%% 
StringContent%% !
(%%! "
JsonSerializer%%" 0
.%%0 1
	Serialize%%1 :
(%%: ;
contentDict%%; F
)%%F G
)%%G H
,%%H I
HttpStatusCode&& 
.&& 
OK&& !
,&&! "
headers'' 
,'' 
$str(( 
)(( 
;(( 
}** 	
private++ 
async++ 
Task++ 
<++ 
string++ !
>++! "
GetResponseContent++# 5
(++5 6
HttpContext++6 A
context++B I
)++I J
{,, 	
var-- 
body-- 
=-- 
$str-- 
;-- 
if.. 
(.. 
context.. 
... 
Response..  
...  !

StatusCode..! +
==.., .
(../ 0
int..0 3
)..3 4
HttpStatusCode..4 B
...B C
NotFound..C K
)..K L
{// 
var00 
req00 
=00 
context00 !
.00! "
Items00" '
.00' (
DownstreamRequest00( 9
(009 :
)00: ;
.00; < 
ToHttpRequestMessage00< P
(00P Q
)00Q R
;00R S
using11 
(11 
var11 
client11 !
=11" #
new11$ '

HttpClient11( 2
(112 3
)113 4
)114 5
{22 
var33 
tempResponse33 $
=33% &
await33' ,
client33- 3
.333 4
GetAsync334 <
(33< =
req33= @
.33@ A

RequestUri33A K
)33K L
;33L M
if44 
(44 
tempResponse44 $
.44$ %
IsSuccessStatusCode44% 8
)448 9
body55 
=55 
await55 $
tempResponse55% 1
.551 2
Content552 9
.559 :
ReadAsStringAsync55: K
(55K L
)55L M
;55M N
}66 
}77 
else88 
body99 
=99 
await99 
context99 $
.99$ %
Items99% *
.99* +
DownstreamResponse99+ =
(99= >
)99> ?
.99? @
Content99@ G
.99G H
ReadAsStringAsync99H Y
(99Y Z
)99Z [
;99[ \
return:: 
body:: 
;:: 
};; 	
private<< 
void<< 
MergeHeaders<< !
(<<! "
HttpContext<<" -
context<<. 5
,<<5 6
List<<7 ;
<<<; <
Header<<< B
><<B C
headers<<D K
)<<K L
{== 	
var>> 
resp>> 
=>> 
context>> 
.>> 
Items>> $
.>>$ %
DownstreamResponse>>% 7
(>>7 8
)>>8 9
;>>9 :
foreach?? 
(?? 
var?? 
hdr?? 
in?? 
resp??  $
.??$ %
Headers??% ,
)??, -
{@@ 
ifAA 
(AA 
headersAA 
.AA 
ExistsAA "
(AA" #
hAA# $
=>AA% '
hAA( )
.AA) *
KeyAA* -
==AA. 0
hdrAA1 4
.AA4 5
KeyAA5 8
)AA8 9
)AA9 :
{BB 
varCC 

currHdrIdxCC "
=CC# $
headersCC% ,
.CC, -
	FindIndexCC- 6
(CC6 7
hCC7 8
=>CC9 ;
hCC< =
.CC= >
KeyCC> A
==CCB D
hdrCCE H
.CCH I
KeyCCI L
)CCL M
;CCM N
varDD 
valuesDD 
=DD  
headersDD! (
[DD( )

currHdrIdxDD) 3
]DD3 4
.DD4 5
ValuesDD5 ;
;DD; <
foreachEE 
(EE 
varEE  
valEE! $
inEE% '
hdrEE( +
.EE+ ,
ValuesEE, 2
)EE2 3
ifFF 
(FF 
!FF 
valuesFF #
.FF# $
ContainsFF$ ,
(FF, -
valFF- 0
)FF0 1
)FF1 2
valuesGG "
=GG# $
valuesGG% +
.GG+ ,
AppendGG, 2
(GG2 3
valGG3 6
)GG6 7
;GG7 8
headersII 
[II 

currHdrIdxII &
]II& '
=II( )
newII* -
HeaderII. 4
(II4 5
hdrII5 8
.II8 9
KeyII9 <
,II< =
valuesII> D
)IID E
;IIE F
}JJ 
elseKK 
headersLL 
.LL 
AddLL 
(LL  
hdrLL  #
)LL# $
;LL$ %
}MM 
}NN 	
}PP 
}QQ ©
KC:\Users\Alan_Orozco\source\repos\NETMentoringProgram\APIGateway\Program.cs
	namespace 	

APIGateway
 
{ 
public 

class 
Program 
{ 
private 
const 
string %
authenticationProviderKey 6
=7 8
$str9 B
;B C
public 
static 
void 
Main 
(  
)  !
{ 	
new 
WebHostBuilder 
( 
)  
. 

UseKestrel 
( 
) 
. 
UseContentRoot 
( 
	Directory %
.% &
GetCurrentDirectory& 9
(9 :
): ;
); <
. %
ConfigureAppConfiguration &
(& '
(' (
hostingContext( 6
,6 7
config8 >
)> ?
=>@ B
{ 
config 
. 
SetBasePath  
(  !
hostingContext! /
./ 0
HostingEnvironment0 B
.B C
ContentRootPathC R
)R S
. 
AddJsonFile  
(  !
$str! 3
,3 4
true5 9
,9 :
true; ?
)? @
. 
AddJsonFile  
(  !
$"! #
$str# /
{/ 0
hostingContext0 >
.> ?
HostingEnvironment? Q
.Q R
EnvironmentNameR a
}a b
$strb g
"g h
,h i
truej n
,n o
truep t
)t u
. 
AddJsonFile  
(  !
$str! .
,. /
false0 5
,5 6
true7 ;
); <
. #
AddEnvironmentVariables ,
(, -
)- .
;. /
} 
) 
.   
ConfigureServices   
(   
s    
=>  ! #
{!! 
s"" 
."" 
AddAuthentication"" #
(""# $
)""$ %
.## 
AddJwtBearer## 
(## %
authenticationProviderKey## 7
,##7 8
opt##9 <
=>##= ?
{$$ 
opt%% 
.%%  
RequireHttpsMetadata%% ,
=%%- .
false%%/ 4
;%%4 5
}&& 
)&& 
;&& 
s(( 
.(( 
	AddOcelot(( 
((( 
)(( 
.)) 
AddCacheManager))  
())  !
x))! "
=>))# %
{** 
x++ 
.++  
WithDictionaryHandle++ *
(++* +
)+++ ,
;++, -
},, 
),, 
.-- )
AddSingletonDefinedAggregator-- .
<--. /!
ItemDetailsAggregator--/ D
>--D E
(--E F
)--F G
;--G H
}.. 
).. 
.// 
ConfigureLogging// 
(// 
(// 
hostingContext// -
,//- .
logging/// 6
)//6 7
=>//8 :
{00 
logging22 
.22 

AddConsole22 "
(22" #
)22# $
;22$ %
}33 
)33 
.44 
UseIISIntegration44 
(44 
)44  
.55 
	Configure55 
(55 
app55 
=>55 
{66 
app77 
.77 
UseAuthentication77 %
(77% &
)77& '
;77' (
app88 
.88 
	UseOcelot88 
(88 
)88 
.88  
Wait88  $
(88$ %
)88% &
;88& '
}99 
)99 
.:: 
Build:: 
(:: 
):: 
.;; 
Run;; 
(;; 
);; 
;;; 
}<< 	
}== 
}>> 